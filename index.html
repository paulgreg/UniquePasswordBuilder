<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="robots" content="index, follow"/>
        <meta name="author" content="Gr&eacute;gory Paul"/>
        <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no" />
        <title>Unique Password Builder Bookmarklet</title>
        <link rel="icon" type="image/png" href="icon.png" />
        <style>
            body                      { margin: .75em; font-family: "Helvetica Neue",Helvetica,Arial,sans-serif; color: #333; font-size: 1em; }

            h1, h2, h3, h4, h5, h6    { margin: 0px; font-weight: bold; text-rendering: optimizelegibility; }
            h1                        { font-size: 30px; line-height: 1.25em; }
            h2                        { border-bottom: 1px solid black; width: 98%; margin: .75em 0 .5em 0;}

            p                         { margin: 0px 0px 9px; line-height: 1.25em; }

            h2.important              { color: #F22; }
            .error                    { border: 2px solid #F22; color: #F22; font-weight: bold; }
            a                         { text-decoration: underline; }
            pre                       { border: 1px solid black; padding: .25em; background-color: #EFE; }
            fieldset                  { border: 1px solid black; background-color: #EFE; padding: .5em; }
            label                     { display: flex; color: #333; }
            input, select, #output    { margin-left: .25em; flex-grow: 1; }
            #output                   { border: 1px dashed black; padding: .25em .5em; }
            a.options                 { text-align: right; display: block; margin: 0 0 .5em 0; }
            .hidden                   { display: none; }

            input:focus, select:focus { border-color: rgba(82, 168, 236, 0.8); box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.075) inset, 0px 0px 8px rgba(82, 168, 236, 0.6); outline: 0px none; }
            input, select             { padding: 4px; margin-bottom: 9px; line-height: 1.25em; color: #555; border: 1px solid #CCC; border-radius: 3px; background-color: white; }
            input                     { height: 18px;}
            button                    { height: 29px; margin-left: 10px; background-color: #EFE; }
            .small                    { font-size: 11px;}

            @media (max-width:800px) {
                label, select, input { display: block; width: 98%; }
            }
        </style>
    </head>
    <body>
        <h1>Unique Password Builder Bookmarklet</h1>

        <h2>Try it yourself :</h2>
        <form>
            <fieldset>
                <label>your master password: <input type="password" id="password" placeholder="Alpha-numeric, lower and upper case characters are required" /></label>
                <label><abbr title="Uniform Resource Locator">URL</abbr>: <input type="text" id="url" /></label>
                <label id="usefulUrl" class="small"></label>
                <a href="" class="options">options</a>
                <div class="options hidden">
                    <label>Algorithm:
                        <select id="algorithm">
                            <option value="scrypt" selected="selected">Scrypt</option>
                            <option value="argon2">Argon2</option>
                        </select>
                    </label>
                    <label>difficulty:
                        <select id="difficultyScrypt">
                            <option value="256">256</option>
                            <option value="512">512</option>
                            <option value="1024">1024</option>
                            <option value="2048">2048</option>
                            <option value="4096">4096</option>
                            <option value="8192" selected="selected">8192</option>
                            <option value="16384">16384</option>
                        </select>
                        <input type="number" id='difficultyArgon2' value='10' max="1000" min="1" class="hidden" />
                    </label>
                    <label>user salt : <input type="text" id="usersalt" value="" /></label>
                </div>
                <label>generated password: <span id="output"></span><button type="button" id="copyToClipboardBtn" class="hidden">Copy to clipboard</button></label>
            </fieldset>
        </form>

        <h2>What is it ?</h2>
        <p>Unique Password Builder’s goal is to generate a strong and different password for each website you want to login while still typing the same password (which I call the <strong>master password</strong>) everywhere.</p>
        <p>You can use Unique Password Builder via one of these options :</p>
        <ul>
            <li>This page,</li>
            <li><a href="https://addons.mozilla.org/en-US/firefox/addon/uniquepasswordbuilder-addon/">Firefox</a> and <a href="https://chrome.google.com/webstore/detail/uniquepasswordbuider/egilgkfibealmbllcigihfhglhipnmie/">Chrome</a> add-ons generating your password that you can then copy and paste,</li>
            <li>A <a href="http://en.wikipedia.org/wiki/Bookmarklet" title="More on bookmarklet">bookmarklet</a> for other browsers that will ask your <strong>master password</strong> and then add a "fill password" link after all password fields.
            Clicking on that link will compute a <strong>unique password</strong> using the <strong>current domain</strong> and your <strong>master password</strong> so it makes a different but very strong password for each website.</li>
        </ul>

        <h2 class="important">Disclaimer / security concerns</h2>
        <p>Generating passwords is a sensitive piece of code, so, I strongly suggest you get the <a href="https://github.com/paulgreg/UniquePasswordBuilder">source code</a> (eventually inspect it) and host the code (including that page) yourself on a SSL/TLS server.</p>
        <p>If you’re not convinced, tell yourself what if I change the password generation code, if there’s a critical bug or if that page is deleted some day...</p>

        <h2>Bookmarklet installation</h2>
        <ol>
            <li>Copy (in the clipboard) the following piece of code :
                <ul>
                    <li>For 'scrypt' hash algorithm (default): <pre class="simple" id="bookmarkletScrypt">javascript:</pre></li>
                    <li>For 'argon2' hash algorithm: <pre class="simple" id="bookmarkletArgon2">javascript:</pre></li>
                </ul>
            </li>
            <li>Create a bookmark and paste the copied code inside the <strong>address field</strong> of the bookmark,</li>
        </ol>
        <p>It’s done !</p>

        <h2>Bookmarklet usage</h2>
        <ol>
            <li>Go to any login form,</li>
            <li>Click on the bookmarklet,</li>
            <li>A form asking your "master password" will appear,</li>
            <li>Type your <strong>master password</strong> in that password field and press <strong>enter</strong>,</li>
            <li>Each password field on the page should then be followed by a "fill password" link,</li>
            <li>Clicking on that link will generate a password, unique for that URL and your master password and will fill it into the password field,</li>
            <li>Optionally, before pressing enter, you can open the developer console to see the new generated password and information about the URL used.</li>
        </ol>
        <p>It’s done, you can submit the form to login.</p>

        <h2>Under the hood</h2>
        <p>We use 2 password-based <a href="https://en.wikipedia.org/wiki/Key_derivation_function">key derivation functions</a> (depending of your options) to generate the password for a site.:
            <a href="http://en.wikipedia.org/wiki/Scrypt">scrypt</a> (by Colin Percival) and <a href="http://en.wikipedia.org/wiki/Argon2">argon2</a> (by Alex Biryukov, Daniel Dinu, and Dmitry Khovratovich).

        <p>Protocol is "http://" or "https://" ; host is the complete domain (including subdomain).</p>
        <h3>Exemple for password 'ThisIsAMasterPassword4UniquePasswordBuilder' and URL 'https://login.yourdomain.com/login'</h3>
        <pre>'-4qYW0P?;j.wBuFV' = scrypt('ThisIsAMasterPassword4UniquePasswordBuilder', 'https://login.yourdomain.com/login', 8192, 8, 1, 64)</pre>
        <p>
            <strong>Beware that, if your master password, the protocol (http/https) or the domain/subdomain changes, the generated password will be different and you won’t be able to login !</strong><br/>
            If that happens, you can always generate the old password using the form above with previous information.
        </p>

        <p>the "user salt" is a parameter added to the URL allowing you to change generated password without changing your master password.</p>
        <p>The Firefox or Chrome addon, that page and the bookmarklet shares code about password generation. You can use one or the other and still get the same password with the same parameters.</p>
        <p>The code includes <a href="https://github.com/dchest/scrypt-async-js">scrypt-async-js</a>, a library from Dmitry Chestnykh,
            <a href="https://github.com/antelle/argon2-browser">argon2-browser</a> and icons are from <a href="http://ikons.piotrkwiatkowski.co.uk/">Piotr Adam Kwiatkowski</a>. Many thanks !</p>
        <p>Thanks to <a href="https://twitter.com/pmiossec">Philippe Miossec</a> for its contributions.</p>
        <p>You may <a href="https://github.com/paulgreg/UniquePasswordBuilder/">check the source code on github</a>, <a href="test/uniquePasswordBuilderTest.html">launch unit tests</a> or find more about me on <a href="http://paulgreg.me">paulgreg.me</a>.

        <h2>Make it stronger...</h2>
        <p>We use 8192 difficulty for scrypt by default (see "difficulty" in form or "window.uniquePasswordBuilderDifficulty" in the bookmarklet above).</p>
        <p>You can adjust it to the value you want but it should be a power of two. The higher the number, the longer it is to brute-force but also will take more time on your platform to generate (that could be an issue on mobile devices)...<p>
        <p>The user salt could be used to make it more resilient against <a href="https://en.wikipedia.org/wiki/Rainbow_table">rainbow table attacks (the longer is the better.)</a>.</p>

        <script src="dist/upb-main.min.js"></script>
        <script>
            (function() {

                // Construct bookmarklet code
                document.querySelector('pre#bookmarkletScrypt').innerHTML += "(function(){window.uniquePasswordBuilderDifficulty=8192;document.body.appendChild(document.createElement('script')).src='"+ window.location.href +"dist/upb.min.js';})();";
                document.querySelector('pre#bookmarkletArgon2').innerHTML += "(function(){window.uniquePasswordBuilderAlgorithm='argon2';window.uniquePasswordBuilderDifficulty=10;window.argon2AsmPath='"+ window.location.href +"';document.body.appendChild(document.createElement('script')).src='"+ window.location.href +"dist/upb.min.js';})();";

                // Init location
                var urlInput                      = document.getElementById('url');
                var usefulUrl                     = document.getElementById('usefulUrl');
                var passwordInput                 = document.getElementById('password');
                var algorithmInput                = document.getElementById('algorithm');
                var difficultyScryptInput         = document.getElementById('difficultyScrypt');
                var difficultyArgon2Input         = document.getElementById('difficultyArgon2');
                var usersaltInput                 = document.getElementById('usersalt');
                var outputSpan                    = document.getElementById('output');
                var copyToClipboardBtn            = document.getElementById('copyToClipboardBtn');
                var optionsLink                   = document.querySelector('a.options');
                var optionsDiv                    = document.querySelector('div.options');

                urlInput.value                    = window.location.protocol + '//' + window.location.host;


                if (localStorage.algorithm) algorithmInput.value = localStorage.algorithm;
                if (localStorage.difficulty) difficultyScryptInput.value = localStorage.difficulty;
                if (localStorage.difficultyArgon2) difficultyArgon2Input.value = localStorage.difficultyArgon2;
                if (localStorage.usersalt) usersaltInput.value = localStorage.usersalt;

                var timeout = null;
                var delay = function(fn) {
                    clearTimeout(timeout);
                    timeout = setTimeout(fn, 250);
                }

                var setErrorMessage = function(message, error) {
                    outputSpan.className = error ? 'error' : '';
                    outputSpan.innerHTML = message;
                    copyToClipboardBtn.className = 'hidden';
                }

                var go = function() {
                    try {
                        outputSpan.className = '';
                        var password = passwordInput.value;
                        var parts = urlInput.value.split('/'); // Extract protocol and host from input value
                        var urlParts = parts.length === 1 ? urlInput.value : { protocol:parts[0], host:parts[2] };
                        if (urlParts || urlParts.protocol || urlParts.host) {
                            if(typeof(urlParts) === 'string') {
                                usefulUrl.textContent = 'Key to generate password: ' + urlParts;
                            } else {
                                usefulUrl.textContent = 'Used part to generate password: ' + (urlParts.protocol || '') + '//' + (urlParts.host || '');
                            }
                        } else {
                            usefulUrl.textContent = '';
                        }

                        if (password.length === 0) {
                            setErrorMessage('Please type a strong password');
                        } else if (!/[a-z]/.test(password)) {
                            setErrorMessage('Password needs lower-case characters', true);
                        } else if (!/[A-Z]/.test(password)) {
                            setErrorMessage('Password needs upper-case characters', true);
                        } else if (!/[\d]/.test(password)) {
                            setErrorMessage('Password needs numerical characters', true);
                        } else if (password.length < 8) {
                            setErrorMessage('Password should be at least 8 characters', true);
                        } else {
                            var algorithm = algorithmInput.value;
                            var difficultyValue = parseInt(algorithmInput.value === 'scrypt' ? difficultyScryptInput.value : difficultyArgon2Input.value, 10);
                            var difficulty = (difficultyValue > 0) ? difficultyValue : 1;
                            var usersalt = usersaltInput.value;

                            localStorage.algorithm = algorithm;
                            localStorage.difficulty = difficultyScryptInput.value;
                            localStorage.difficultyArgon2 = difficultyArgon2Input.value;
                            localStorage.usersalt = usersalt;

                            outputSpan.innerHTML = "Generating password...";
                            UniquePasswordBuilder.generate(algorithm, urlParts, difficulty, password, usersalt, function(generatedPassword) {
                                outputSpan.innerHTML = generatedPassword;
                                copyToClipboardBtn.className = '';
                            });
                        }
                    } catch(e) {
                        setErrorMessage(e, true);
                    }
                }

                var delayedGo = delay.bind(this, go);

                var toggleOptions = function(e) {
                    e.preventDefault();
                    optionsDiv.classList.toggle('hidden');
                }

                var copyToClipboard = function() {
                    var password = outputSpan.textContent;
                    var hiddenInputToCopy = document.createElement("input");
                    document.body.appendChild(hiddenInputToCopy);
                    hiddenInputToCopy.value = password;
                    hiddenInputToCopy.select();
                    document.execCommand("copy");
                    hiddenInputToCopy.remove();
                    return false;
                }

                var changeAlgorithm = function() {
                    difficultyScryptInput.className = algorithmInput.value == 'scrypt' ? '' : 'hidden';
                    difficultyArgon2Input.className = algorithmInput.value == 'argon2' ? '' : 'hidden';
                    delayedGo();
                }

                algorithmInput.addEventListener('change', changeAlgorithm, false);
                passwordInput.addEventListener('keyup', delayedGo, false);
                urlInput.addEventListener('keyup', delayedGo, false);
                difficultyScryptInput.addEventListener('change', delayedGo, false);
                difficultyArgon2Input.addEventListener('change', delayedGo, false);
                usersaltInput.addEventListener('keyup', delayedGo, false);
                usersaltInput.addEventListener('change', delayedGo, false);
                optionsLink.addEventListener('click', toggleOptions, false);
                copyToClipboardBtn.addEventListener('click', copyToClipboard, false);

                changeAlgorithm();


                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js').then(function() {
                        console.log('service worker registration complete');
                    }, function(e) {
                        console.log('service worker registration failure:', e);
                    });
                }

            })();


        </script>
    </body>
</html>
